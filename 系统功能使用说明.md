# 七曲山寺庙智能上香系统 - 功能使用说明

## 目录
1. [系统概述](#系统概述)
2. [用户角色说明](#用户角色说明)
3. [管理员功能](#管理员功能)
4. [员工功能](#员工功能)
5. [游客功能](#游客功能)
6. [核心业务流程](#核心业务流程)

---

## 系统概述

七曲山寺庙智能上香系统是一个基于座位选择的上香管理系统，类似电影院选座的方式。系统支持：
- 位置配置管理（类似影厅配置）
- 座位管理（类似电影院座位）
- 游客上香记录管理
- 香品管理
- 员工管理

---

## 用户角色说明

### 1. 管理员（Admin）
- **权限范围**：系统所有功能
- **主要职责**：
  - 管理岗位和员工
  - 配置位置和座位
  - 管理香品类型
  - 查看所有上香记录
  - 系统配置管理

### 2. 员工（Employee）
- **权限范围**：业务操作功能
- **主要职责**：
  - 为游客办理上香业务
  - 搜索和创建游客信息
  - 查看自己办理的记录

### 3. 游客（Tourist）
- **权限范围**：查询功能
- **主要职责**：
  - 查询自己的上香记录
  - 查看可用座位信息

---

## 管理员功能

### 1. 岗位管理

#### 1.1 创建岗位
- **路径**：`POST /api/v1/admin/posts`
- **功能**：创建新的岗位（如：大殿服务岗、偏殿服务岗等）
- **必填字段**：
  - `name`: 岗位名称
  - `code`: 岗位代码（用于生成员工账号）
- **可选字段**：
  - `description`: 岗位描述

#### 1.2 岗位列表
- **路径**：`GET /api/v1/admin/posts`
- **功能**：查看所有岗位列表
- **支持筛选**：可按状态筛选

#### 1.3 更新/删除岗位
- **路径**：`PUT /api/v1/admin/posts/:id`、`DELETE /api/v1/admin/posts/:id`
- **注意**：删除岗位前需确保没有员工关联

### 2. 员工管理

#### 2.1 创建员工
- **路径**：`POST /api/v1/admin/employees`
- **流程**：
  1. 先发送短信验证码到员工手机
  2. 验证短信验证码
  3. 创建员工账号（系统自动生成用户名）
- **必填字段**：
  - `name`: 员工姓名
  - `phone`: 手机号
  - `post_id`: 所属岗位ID
  - `password`: 登录密码
  - `sms_code`: 短信验证码

#### 2.2 员工列表
- **路径**：`GET /api/v1/admin/employees`
- **支持筛选**：按岗位、状态筛选
- **支持分页**：page、page_size参数

#### 2.3 员工操作
- 查看详情：`GET /api/v1/admin/employees/:id`
- 更新信息：`PUT /api/v1/admin/employees/:id`
- 修改密码：`PUT /api/v1/admin/employees/:id/password`
- 删除员工：`DELETE /api/v1/admin/employees/:id`（软删除）

### 3. 位置配置管理

#### 3.1 创建位置配置
- **路径**：`POST /api/v1/admin/position-configs`
- **功能**：创建位置配置（类似创建影厅配置）
- **必填字段**：
  - `name`: 配置名称（如：大殿、偏殿）
  - `type`: 配置类型
    - `grid`: 网格布局（每行列数相同）
    - `custom`: 自定义布局（每行列数可以不同）
  - `layout_config`: 布局配置（JSON格式）
    ```json
    [
      {"row": 1, "cols": 8},
      {"row": 2, "cols": 8},
      {"row": 3, "cols": 6},
      {"row": 4, "cols": 6}
    ]
    ```
- **可选字段**：
  - `image_url`: 配置图片URL
  - `description`: 配置描述
- **自动功能**：创建配置后，系统会自动根据`layout_config`生成所有座位

#### 3.2 位置配置列表
- **路径**：`GET /api/v1/admin/position-configs`
- **支持筛选**：按状态筛选
- **返回**：配置列表，包含配置基本信息

#### 3.3 查看配置详情
- **路径**：`GET /api/v1/admin/position-configs/:id`
- **返回**：配置详情及关联的所有座位

#### 3.4 更新位置配置
- **路径**：`PUT /api/v1/admin/position-configs/:id`
- **限制**：
  - 如果配置已有上香记录，无法修改`layout_config`
  - 修改`layout_config`会删除旧座位并重新生成
- **可更新字段**：
  - `name`: 配置名称
  - `type`: 配置类型
  - `layout_config`: 布局配置（需无历史记录）
  - `image_url`: 图片URL
  - `description`: 描述
  - `status`: 状态（1-启用，0-停用）

#### 3.5 删除位置配置
- **路径**：`DELETE /api/v1/admin/position-configs/:id`
- **限制**：如果配置有上香记录，无法删除（可设为停用）
- **操作**：删除配置及所有关联座位

### 4. 座位管理

#### 4.1 创建座位（手动）
- **路径**：`POST /api/v1/admin/positions`
- **说明**：通常座位由配置自动生成，此接口用于手动创建特殊座位
- **必填字段**：
  - `position_config_id`: 位置配置ID
  - `row`: 行号（从1开始）
  - `col`: 列号（从1开始）
  - `name`: 座位名称（如：A1、B2）

#### 4.2 座位列表
- **路径**：`GET /api/v1/admin/positions`
- **支持筛选**：
  - `position_config_id`: 按配置筛选
  - `status`: 按状态筛选
  - `row`: 按行号筛选
- **排序**：按行号、列号排序

#### 4.3 按配置查询座位
- **路径**：`GET /api/v1/admin/positions/config/:config_id`
- **返回**：按行组织的座位数据，便于前端展示

#### 4.4 座位操作
- 查看详情：`GET /api/v1/admin/positions/:id`
- 更新座位：`PUT /api/v1/admin/positions/:id`
  - 可更新：名称、容量、状态、描述、行列号
- 删除座位：`DELETE /api/v1/admin/positions/:id`
  - 限制：有历史记录无法删除
- 查看占用历史：`GET /api/v1/admin/positions/:id/history`

### 5. 香品管理

#### 5.1 创建香品
- **路径**：`POST /api/v1/admin/incense-types`
- **必填字段**：
  - `name`: 香品名称（如：檀香、沉香）
- **可选字段**：
  - `description`: 香品描述

#### 5.2 香品操作
- 列表：`GET /api/v1/admin/incense-types`
- 详情：`GET /api/v1/admin/incense-types/:id`
- 更新：`PUT /api/v1/admin/incense-types/:id`
- 删除：`DELETE /api/v1/admin/incense-types/:id`
- 统计：`GET /api/v1/admin/incense-types/statistics`
  - 返回各香品的使用次数统计

### 6. 上香记录查询

#### 6.1 查询所有记录
- **路径**：`GET /api/v1/admin/incense-records`
- **支持筛选**：
  - `employee_id`: 按员工筛选
  - `position_id`: 按座位筛选
  - `start_date`: 开始日期
  - `end_date`: 结束日期
- **支持分页**：page、page_size参数

---

## 员工功能

### 1. 游客管理

#### 1.1 搜索游客
- **路径**：`GET /api/v1/employee/tourists/search`
- **参数**：
  - `name`: 游客姓名（可选）
  - `phone`: 手机号（可选）
- **功能**：根据姓名和手机号搜索游客
- **返回**：匹配的游客列表

#### 1.2 查看游客详情
- **路径**：`GET /api/v1/employee/tourists/:id`
- **返回**：游客详细信息及历史记录

### 2. 上香记录管理

#### 2.1 创建上香记录
- **路径**：`POST /api/v1/employee/incense-records`
- **流程**：
  1. 输入游客信息（姓名、手机号）
  2. 系统自动查找或创建游客
  3. 选择座位（从位置配置中选择）
  4. 选择香品类型
  5. 选择时间段（开始时间、结束时间）
  6. 系统检查座位可用性
  7. 创建记录
- **必填字段**：
  - `tourist_name`: 游客姓名
  - `tourist_phone`: 游客手机号
  - `position_id`: 座位ID
  - `incense_type_id`: 香品ID
  - `start_time`: 开始时间（ISO 8601格式）
  - `end_time`: 结束时间（ISO 8601格式）
- **可选字段**：
  - `tourist_id_card`: 身份证号
- **时间规则**：
  - 时间必须是配置的时间颗粒度的整数倍（如：15分钟）
  - 必须在营业时间内
  - 开始时间不能早于当前时间
  - 时长不能超过最大时长限制
- **自动功能**：
  - 如果游客不存在，自动创建
  - 保存员工信息快照
  - 保存位置路径快照
  - 更新香品使用次数

#### 2.2 查看我的记录
- **路径**：`GET /api/v1/employee/incense-records/my`
- **功能**：查看当前员工办理的所有上香记录
- **支持分页**：page、page_size参数

---

## 游客功能

### 1. 查询上香记录

#### 1.1 查询记录
- **路径**：`POST /api/v1/public/tourist/records`
- **功能**：根据姓名和手机号查询上香记录
- **必填字段**：
  - `name`: 游客姓名
  - `phone`: 手机号
- **返回**：
  - 记录列表
  - 每条记录包含：
    - 位置信息（配置名称-座位名称）
    - 香品名称
    - 开始时间、结束时间
    - 剩余时间（如果未结束）
    - 创建时间
- **安全**：无需登录，但需要提供姓名和手机号验证

### 2. 查看可用座位

#### 2.1 查询可用座位
- **路径**：`GET /api/v1/public/positions/available`
- **参数**：
  - `position_config_id`: 位置配置ID（可选）
- **返回**：可用座位列表
- **功能**：游客可以查看哪些座位可用

---

## 核心业务流程

### 业务流程1：管理员初始化系统

1. **创建岗位**
   ```
   创建岗位 → 获取岗位ID
   ```

2. **创建员工**
   ```
   发送短信验证码 → 验证码 → 创建员工 → 自动生成用户名
   ```

3. **创建位置配置**
   ```
   创建配置 → 填写布局信息 → 系统自动生成座位
   ```

4. **创建香品**
   ```
   创建香品类型 → 设置名称和描述
   ```

### 业务流程2：员工办理上香业务

1. **员工登录**
   ```
   输入用户名密码 → 获取Token
   ```

2. **搜索游客**
   ```
   输入姓名+手机号 → 查询游客 → 不存在则创建
   ```

3. **选择座位**
   ```
   查询位置配置 → 显示座位布局 → 游客选择座位
   ```

4. **选择香品和时间**
   ```
   选择香品类型 → 选择时间段 → 系统检查可用性
   ```

5. **创建记录**
   ```
   确认信息 → 创建上香记录 → 返回记录详情
   ```

### 业务流程3：游客查询记录

1. **输入信息**
   ```
   输入姓名和手机号 → 提交查询
   ```

2. **系统验证**
   ```
   验证手机号格式 → 查询游客 → 查询记录
   ```

3. **返回结果**
   ```
   返回记录列表 → 显示位置、香品、时间等信息
   ```

---

## 注意事项

### 1. 时间管理
- 系统有营业时间限制
- 时间必须是配置的颗粒度的整数倍
- 上香时长有最大限制

### 2. 座位管理
- 座位容量默认为1（支持1人同时上香）
- 可以设置座位容量支持多人
- 系统会检查时间段冲突

### 3. 数据安全
- 删除操作都是软删除
- 有历史记录的数据无法删除
- 员工和位置信息会保存快照，防止历史数据丢失

### 4. 布局配置
- `grid`类型：每行列数相同，适合规整布局
- `custom`类型：每行列数可以不同，适合不规则布局
- 修改布局配置会重新生成座位（需无历史记录）

---

## 常见问题

### Q1: 如何修改位置配置的布局？
A: 如果配置没有上香记录，可以通过更新接口修改`layout_config`，系统会自动删除旧座位并生成新座位。

### Q2: 座位被占用怎么办？
A: 系统会检查时间段冲突，如果时间段有冲突，会提示选择其他座位或时间。

### Q3: 游客忘记了自己的记录怎么办？
A: 游客可以通过公开接口，输入姓名和手机号查询自己的所有记录。

### Q4: 如何查看某个座位的占用历史？
A: 管理员可以通过`GET /api/v1/admin/positions/:id/history`接口查看座位的占用历史。

### Q5: 座位名称是如何生成的？
A: 系统自动生成，格式为：行号字母（A-Z）+ 列号数字（1-N），如：A1、B2、C3等。

